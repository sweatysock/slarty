const SampleRate=16e3,PerfSampleRate=32e3,PacketSize=500,PerfPacketSize=PacketSize*PerfSampleRate/16000,HighFilterFreq=16000/2.2,LowFilterFreq=200,ChunkSize=1024;var soundcardSampleRate=null,micAudioPacketSize=0,adjMicPacketSize=0,socketConnected=!1,micAccessAllowed=!1,packetBuf=[],spkrBufferL=[],spkrBufferR=[],smoothingNeeded=!1,venueBuffer=[],smoothingNeededV=!1,maxBuffSize=2e4,micBufferL=[],micBufferR=[],noiseThreshold=.02,myNoiseFloor=.02,myChannel=-1,myName="",MaxNameLength=15,myGroup="noGroup",groupLayout=[8,12,4,10,6,9,7,11,5,13,3,14,2,15,1,16,0,4,10,6,9],pans=[-9,-5,-3,-2.4,-2,-1.7,-1.4,-1.2,1,1.2,1.4,1.7,2,2.4,3,5,9],chatAdj=[0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80],groupCentre=8,maxGroupSize=17,myPos=0,performer=!1,loopback=!1,stereoOn=!0,HQOn=!0;const NumberOfChannels=20;var channels=[];for(let e=0;e<NumberOfChannels;e++)channels[e]={name:"",gain:1,agc:!0,muted:!1,peak:0,channel:e,seq:0,buffer8:[],buffer16:[]};var liveShow=!1,serverLiveChannels=[],mixOut={name:"Output",gain:0,gainRate:100,targetGain:1,ceiling:1,agc:!0,muted:!1,peak:0,channel:"mixOut"},micIn={name:"Mic",gain:0,gainRate:100,targetGain:1,ceiling:1,agc:!0,muted:!1,peak:0,channel:"micIn",threshold:0,gate:0},venue={name:"Venue",gain:0,gainRate:50,targetGain:1,ceiling:1,agc:!0,muted:!1,peak:0,channel:"venue"},blocked=0,goodCount=0,recording=!1,serverMuted=!1,venueSize=1,venueSizeCmd=0,audience=1,rtt=0,rtt1=0,rtt5=0,smooth=[];for(let e=0;400>e;e++)smooth[e]=Math.cos(e/400*Math.PI)/2+.5;var bubbleArea,chatHistory,chatText="";function processCommands(e){if(serverMuted=null!=e.mute&&e.mute,null!=e.gateDelay&&(gateDelay=e.gateDelay),null!=e.venueSize&&(venueSizeCmd=e.venueSize),null!=e.perfLevel&&performer&&(micIn.gain=e.perfLevel,micIn.agc=!1),null!=e.noiseThreshold&&(noiseThreshold=e.noiseThreshold),null!=e.displayURL);if(null!=e.displayText);}var socketIO=io();socketIO.on("connect",function(){trace("socket connected!");let e=new URLSearchParams(window.location.search),t=e.get("key");null==t&&(window.location.href="https://audence.com/error-serveraccess"),socketIO.emit("upstreamHi",{channel:myChannel,key:t})}),socketIO.on("channel",function(e){if(0<e.channel){myChannel=e.channel,""==myName&&(myName="Input "+myChannel),micIn.name="Mic ("+myChannel+")";let t=document.getElementById("ID"+micIn.channel+"Name");if(null!=t&&(t.innerHTML=micIn.name),trace("Channel assigned: ",myChannel),socketConnected=!0,pitch=0,e.loopback?(loopback=!0,performer=!0,document.getElementById("onair").style.visibility="visible",micFilter1.frequency.value=PerfSampleRate/2.2,micFilter2.frequency.value=30):loadVenueReverb(e.reverb),myGroup=e.defGroup,"noGroup"!=myGroup){let e=document.getElementById("groupNameEntry");null!=e&&(e.innerHTML=myGroup)}}else trace("Server unable to assign a channel"),trace("Try a different server"),socketConnected=!1}),socketIO.on("perf",function(e){performer=e.live,!0==performer?(document.getElementById("onair").style.visibility="visible",micFilter1.frequency.value=PerfSampleRate/2.2,micFilter2.frequency.value=30):(document.getElementById("onair").style.visibility="hidden",micFilter1.frequency.value=HighFilterFreq,micFilter2.frequency.value=LowFilterFreq)}),socketIO.on("d",function(e){enterState(dataInState),packetsIn++;let t=JSON.stringify(e).length/1024;if(bytesRcvd+=t,serverLiveChannels=e.liveChannels,processCommands(e.commands),!micAccessAllowed)return void enterState(idleState);let n=Array(adjMicPacketSize).fill(0),l=Array(PacketSize/2).fill(0),o=Array(PacketSize/2).fill(0),s=[],a=[],i=!1,d=Array(PacketSize/2).fill(0),r=Array(PacketSize/2).fill(0),h=Array(PacketSize/2).fill(0),u=Array(PacketSize/2).fill(0),m=!1,y=serverLiveChannels[myChannel],f=groupLayout[y];if(e.channels.forEach(e=>{let t=e.channel,i=channels[t];i.name=e.name,i.channel=t;let n=serverLiveChannels[t],s=groupLayout[n];s=(s+(groupCentre-f))%maxGroupSize;let a=pans[s];if(""!=e.chatText&&chatMessage(e.name,e.chatText,s),e.socketID!=socketIO.id&&0!=t){i.peak<e.peak&&(i.peak=e.peak);let t=e.audio,n=t.mono8,s=t.mono16,y=i.buffer8,v=i.buffer16,f=i.agc?mixOut.gain:i.gain;if(i.gain=f,f=i.muted?0:f,0<n.length){m=!0;let e=0,t=0;if(0>a){t=-1*a;for(let e=0;e<n.length;e++)d[e]+=n[e]*f,l[e]+=n[e],h[e]+=n[e]*f/t}else{e=a;for(let t=0;t<n.length;t++)h[t]+=n[t]*f,l[t]+=n[t],d[t]+=n[t]*f/e}}if(0<s.length){let e=0,t=0;if(0>a){t=-1*a;for(let e=0;e<s.length;e++)r[e]+=s[e]*f,o[e]+=s[e],u[e]+=s[e]*f/t}else{e=a;for(let t=0;t<s.length;t++)u[t]+=s[t]*f,o[t]+=s[t],r[t]+=s[t]*f/e}}}e.sequence!=i.seq+1&&trace("Sequence jump Channel ",t," jump ",e.sequence-i.seq),i.seq=e.sequence}),m){let e=0;for(let t=0;t<d.length;t++)s[e]=d[t]+r[t],a[e]=h[t]+u[t],e++,s[e]=d[t]-r[t],a[e]=h[t]-u[t],e++;s=reSample(s,gLCache,adjMicPacketSize),a=reSample(a,gRCache,adjMicPacketSize),i=!0}let b=[],I=[];if(0<s.length)b=s,I=a;else{let e=adjMicPacketSize;b=Array(e).fill(0),I=Array(e).fill(0)}let B=0,g=e.venue;if(null!=g){B=g.timestamps[myChannel],audience=g.liveClients,venueSize=0==venueSizeCmd?audience:venueSizeCmd;let e=[],t=[],i=g.seqNos[myChannel];if(null!=i)for(;packetBuf.length;){let n=packetBuf.shift();if(n.sequence==i){e=n.audio.mono8,t=n.audio.mono16;break}}let s=zipson.parse(g.audio),a=s.mono8,d=s.mono16;if(0<a.length&&!venue.muted){venue.gain/venueSize;if(0<e.length&&0<l.length)for(let t=0;t<e.length;++t)a[t]=a[t]-e[t]-l[t];if(0<e.length&&0==l.length)for(let t=0;t<e.length;++t)a[t]-=e[t];if(0==e.length&&0<l.length)for(let e=0;e<l.length;++e)a[e]-=l[e];if(0<d.length){if(0<t.length&&0<o.length)for(let e=0;e<t.length;++e)d[e]=d[e]-t[e]-o[e];if(0<t.length&&0==o.length)for(let e=0;e<t.length;++e)d[e]-=t[e];if(0==t.length&&0<o.length)for(let e=0;e<o.length;++e)d[e]-=o[e];let e=0;for(let t=0;t<a.length;t++)n[e]=a[t]+d[t],e++,n[e]=a[t]-d[t],e++}else n=a;let i=applyAutoGain(n,venue);venue.gain=i.finalGain,i.peak>venue.peak&&(venue.peak=i.peak),n=reSample(n,vCache,adjMicPacketSize)}}if(performer=e.perf.chan==myChannel,liveShow=e.perf.live,e.perf.live&&null!=e.perf.packet&&!1!=e.perf.packet.perfAudio){let t=zipson.parse(e.perf.packet.perfAudio),n=t.mono8,l=t.mono16,o=t.mono32;if(!performer||loopback){let e=[],a=[],r=0,g=0,s=32e3;if(0==n.length){Array(250).fill(0);s=8e3}else if(0==l.length)e=n,s=8e3;else if(0==o.length){for(let t=0;t<n.length;t++)e[g]=n[t]+l[t],g++,e[g]=n[t]-l[t],g++;s=16e3}else for(let t=0;t<n.length;t++){let i=n[t]+l[t],s=n[t]-l[t];e[g]=i+o[r],g++,e[g]=i-o[r],r++,g++,e[g]=s+o[r],g++,e[g]=s-o[r],r++,g++}e=reSample(e,upCachePerfM,adjMicPacketSize);let h=t.stereo8,u=t.stereo16,m=t.stereo32;if(0<h.length){if(i=!0,r=0,g=0,0==u.length)a=h,s=8e3;else if(0==m.length){for(let e=0;e<h.length;e++)a[g]=h[e]+u[e],g++,a[g]=h[e]-u[e],g++;s=16e3}else for(let e=0;e<h.length;e++){let t=h[e]+u[e],i=h[e]-u[e];a[g]=t+m[r],g++,a[g]=t-m[r],r++,g++,a[g]=i+m[r],g++,a[g]=i-m[r],r++,g++}a=reSample(a,upCachePerfS,adjMicPacketSize);let t=[],n=[];for(let l=0;l<e.length;l++)t[l]=(e[l]+a[l])/2,n[l]=(e[l]-a[l])/2;if(0==b.length)b=t,I=n;else for(let e=0;e<t.length;e++)b[e]+=t[e],I[e]+=n[e]}else if(0==b.length)b=e,I=e;else{i=!0;for(let t=0;t<e.length;t++)b[t]+=e[t],I[t]+=e[t]}}else B=e.perf.packet.timestamp;loopback&&(B=e.perf.packet.timestamp);let s=e.perf.packet;if("noGroup"!=myGroup&&s.group==myGroup&&""!=s.chatText){let e=s.channel,t=serverLiveChannels[e],i=groupLayout[t],n=serverLiveChannels[myChannel],l=groupLayout[n];i=(i+(groupCentre-l))%maxGroupSize,chatMessage(s.name,s.chatText,i)}}let k;if(i){let e=maxValue(b),t=maxValue(I);e>t?(k=applyAutoGain(b,mixOut),applyGain(I,k.finalGain)):(k=applyAutoGain(I,mixOut),applyGain(b,k.finalGain))}else k=applyAutoGain(b,mixOut);if(mixOut.gain=k.finalGain,k.peak+=venue.peak,k.peak>mixOut.peak&&(mixOut.peak=k.peak),spkrBufferL.length<spkrBuffTrough&&(spkrBuffTrough=spkrBufferL.length),spkrBufferL.push(...b),i?spkrBufferR.push(...I):spkrBufferR.push(...b),spkrBufferL.length>maxBuffSize){let e=spkrBufferL.length-maxBuffSize;spkrBufferL.splice(maxBuffSize/2,maxBuffSize/2),spkrBufferR.splice(maxBuffSize/2,maxBuffSize/2),overflows++,pitch>-1*pitchLimit&&pitch--,bytesOver+=e}if(spkrBufferL.length>spkrBuffPeak&&(spkrBuffPeak=spkrBufferL.length),0<n.length&&venueBuffer.push(...n),venueBuffer.length>maxBuffSize&&(venueBuffer.splice(maxBuffSize/2,maxBuffSize/2),overflows++,pitch>-1*pitchLimit&&pitch--),0<B){let e=new Date().getTime();rtt=e-B,rtt1=0==rtt1?rtt:(9*rtt1+rtt)/10,rtt5=(49*rtt5+rtt)/50}enterState(idleState)}),socketIO.on("disconnect",function(){trace("socket disconnected!"),socketConnected=!1,pitch=0});var displayRefresh=100;document.addEventListener("DOMContentLoaded",function(){tracef("Starting V1.0");let e=document.getElementById("groupBtn"),t=document.getElementById("groupNameEntry"),i=document.getElementById("nickname"),n=document.getElementById("inputText"),l=document.getElementById("chatWin"),o=document.getElementById("nameBadge"),s=document.getElementById("chatInput");bubbleArea=document.getElementById("chatBubbleArea"),chatHistory=document.getElementById("chatHistory"),e.onclick=()=>{t.style.visibility="visible",r.style.visibility="hidden","noGroup"==myGroup?(t.value="",t.focus()):(t.value=myGroup,o.style.visibility="visible",i.focus(),s.style.visibility="visible")},t.setAttribute("maxlength",30),t.addEventListener("keydown",n=>{32===n.which&&n.preventDefault(),13===n.which&&(""==t.value?(myGroup="noGroup",o.style.visibility="hidden",s.style.visibility="hidden",l.style.visibility="hidden",bubbleArea.style.visibility="hidden",t.blur()):(o.style.visibility="visible",s.style.visibility="visible",l.style.visibility="hidden",bubbleArea.style.visibility="visible",i.focus()),n.preventDefault())}),t.addEventListener("focusout",()=>{""==t.value?(myGroup="noGroup",o.style.visibility="hidden",s.style.visibility="hidden",l.style.visibility="hidden",bubbleArea.style.visibility="hidden",t.blur()):(myGroup!=t.value&&(chatHistory.innerHTML+="<div style='color:#FFCC00'>Group changed from "+myGroup+" to "+t.value+"</div>",chatHistory.scrollTop=chatHistory.scrollHeight),myGroup=t.value,o.style.visibility="visible",s.style.visibility="visible",l.style.visibility="hidden",bubbleArea.style.visibility="visible",i.focus())}),i.setAttribute("maxlength",MaxNameLength),i.addEventListener("keydown",t=>{13===t.which&&(n.focus(),t.preventDefault())}),i.addEventListener("focusout",()=>{""==i.value?i.value=myName:i.value!=myName&&(chatHistory.innerHTML+="<div style='color:#FFCC00'>"+myName+" changed to "+i.value+"</div>",chatHistory.scrollTop=chatHistory.scrollHeight,myName=i.value),document.getElementById("IDmicInName").innerHTML=myName}),n.addEventListener("keydown",t=>{13===t.which&&(chatText=n.value,n.value="",t.preventDefault())});let a=document.getElementById("chatHistBtn");a.onclick=()=>{"hidden"==l.style.visibility?(bubbleArea.style.visibility="hidden",l.style.visibility="visible"):(bubbleArea.style.visibility="visible",l.style.visibility="hidden")};let d=document.getElementById("helpBtn"),r=document.getElementById("helpp");d.onclick=()=>{r.style.visibility="hidden"==r.style.visibility?"visible":"hidden"};let g=document.getElementById("micMuted"),h=document.getElementById("micOpen");g.onclick=()=>{let e=document.getElementById("IDmicInOn");micIn.muted=!1,g.style.visibility="hidden",h.style.visibility="visible",e.style.visibility="inherit",forcedMute&&(trace2("FORCE UNmute"),micIn.gate=40,forcedMute=!1)},h.onclick=()=>{let e=document.getElementById("IDmicInOn");micIn.muted=!0,g.style.visibility="visible",h.style.visibility="hidden",e.style.visibility="hidden"},navigator.mediaDevices.addEventListener("devicechange",()=>{navigator.mediaDevices.enumerateDevices().then(e=>{tracef(JSON.stringify(e))})}),navigator.mediaDevices.enumerateDevices().then(e=>{tracef("foo ",JSON.stringify(e))})});function chatMessage(e,t,i){chatHistory.innerHTML+="<div><span style='color:#FFFFFF'>"+e+": </span>"+t+"</div>",chatHistory.scrollTop=chatHistory.scrollHeight;let n=chatAdj[i],l=document.createElement("div");l.style.left=n+"%",l.classList.add("chatBubble"),l.innerHTML="<span style='color:#FFFFFF'>"+e+": </span>"+t+"</div>",setTimeout(function(){l.parentNode.removeChild(l)},15e3),bubbleArea.appendChild(l)}function displayAnimation(){enterState(UIState);const e=.8;if(micAccessAllowed)for(let t in mixOut.peak*=e,setLevelDisplay(mixOut),setSliderPos(mixOut),micIn.peak*=e,setLevelDisplay(micIn),setSliderPos(micIn),loopback||setThresholdPos(micIn),venue.peak*=e,setLevelDisplay(venue),setSliderPos(venue),channels)if(c=channels[t],""!=c.name&&c.channel!=myChannel)if(null==serverLiveChannels[t])removeChannelUI(c);else{null==c.displayID&&createChannelUI(c),c.peak*=e,setLevelDisplay(c),setSliderPos(c);let t="ID"+c.channel+"Name",i=document.getElementById(t);i.innerHTML=c.name}1e3>=displayRefresh&&setTimeout(displayAnimation,displayRefresh),enterState(idleState)}var forcedMute=!1;function updateUIMute(){echoRisk&&!micIn.muted&&(forcedMute&&1>=micIn.threshold?(document.getElementById("IDmicInOn").style.visibility="inherit",document.getElementById("micMuted").style.visibility="hidden",document.getElementById("micOpen").style.visibility="visible",forcedMute=!1):!forcedMute&&1<micIn.threshold&&(document.getElementById("IDmicInOn").style.visibility="hidden",document.getElementById("micMuted").style.visibility="visible",document.getElementById("micOpen").style.visibility="hidden",forcedMute=!0))}function toggleSettings(){let e=document.getElementById("mixerViewer");"hidden"==e.style.visibility?(e.style.visibility="visible",displayRefresh=100,setTimeout(displayAnimation,displayRefresh)):(e.style.visibility="hidden",displayRefresh=2e3)}function mapToLevelDisplay(e){let t=0;return .01<e&&(t=65*(10.5*Math.log10(e)+21)/21),t}function setLevelDisplay(e){let t,i,n,l=e.peak;l=mapToLevelDisplay(l),49.5>l?(t=l,i=0,n=0):58.8>l?(t=49.5,i=l-49.5,n=0):(t=49.5,i=9.3,n=l-58.8);let o=document.getElementById(e.displayID+"LevelGreen");o.style.height=t+"%",o=document.getElementById(e.displayID+"LevelOrange"),o.style.height=i+"%",o=document.getElementById(e.displayID+"LevelRed"),o.style.height=n+"%"}function setThresholdPos(e){let t=e.threshold;0<t&&.011>t&&(t=.011),t=mapToLevelDisplay(t);let i=document.getElementById(e.displayID+"Threshold");i.style.height=t+"%"}function setSliderPos(e){let t,i=e.gain;t=1>i?34*i+8:2.5*i+39.5;let n=document.getElementById(e.displayID+"Slider");n.style.bottom=t+"%"}function createChannelUI(e){let t="ID"+e.channel,i=" <div id=\""+t+"\" style=\"position:relative;width:100px; height:100%; display: inline-block\"> \t\t\t<img style=\"position:relative;bottom:0%; right:0%; width:100%; height:99%;\" src=\"images/controlBG.png\">  \t\t\t<img style=\"position:absolute;bottom:8%; right:5%; width:40%; height:10%;\" src=\"images/slider.png\" id=\""+t+"Slider\" >  \t\t\t<div style=\"position:absolute;bottom:8%; right:5%; width:90%; height:65%;\" draggable=\"false\" id=\""+t+"SlideBtn\" \t\t\t\tonmousedown=\"sliderDragStart(event)\" onmousemove=\"sliderDrag(event)\" onmouseup=\"sliderDragStop(event)\" \t\t\t\tontouchstart=\"sliderDragStart(event)\" ontouchmove=\"sliderDrag(event)\" ontouchend=\"sliderDragStop(event)\"></div>  \t\t\t<div style=\"position:absolute;bottom:8%; left:25%; width:5%; height:0%; background-color:#66FF33\" id=\""+t+"LevelGreen\"></div> \t\t\t<div style=\"position:absolute;bottom:57.5%; left:25%; width:5%; height:0%; background-color:#FF6600\" id=\""+t+"LevelOrange\"></div> \t\t\t<div style=\"position:absolute;bottom:66.8%; left:25%; width:5%; height:0%; background-color:#FF0000\" id=\""+t+"LevelRed\"></div> \t\t\t<div style=\"position:absolute;bottom:8%; left:25%; width:5%; height:0%; background-color:#999999\" id=\""+t+"Threshold\"></div> \t\t\t<img style=\"position:absolute;right:30%; top:10%;width:40%; padding-bottom:10%;\" src=\"images/channelOff.png\" id=\""+t+"Off\" onclick=\"unmuteButton(event)\">  \t\t\t<img style=\"position:absolute;right:30%; top:10%;width:40%; padding-bottom:10%;\" src=\"images/channelOn.png\" id=\""+t+"On\" onclick=\"muteButton(event)\">  \t\t\t<img style=\"position:absolute;right:30%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/AGCOff.png\" id=\""+t+"AGCOff\" onclick=\"agcButton(event)\">  \t\t\t<img style=\"position:absolute;right:30%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/AGCOn.png\" id=\""+t+"AGCOn\" onclick=\"agcButton(event)\">  \t\t\t<div style=\"position:absolute;top:1%; left:3%; width:90%; height:10%;color:#AAAAAA; font-size: 3vmin\" id=\""+t+"Name\"> \t\t\t\t<marquee behavior=\"slide\" direction=\"left\">"+e.name+"</marquee> \t\t\t</div> \t\t</div>",n=document.getElementById("mixerRack");n.innerHTML+=i,e.displayID=t}function createOutputUI(e){let t="ID"+e.channel,i=" <div id=\""+t+"\" style=\"position:relative;width:100px; height:100%; display: inline-block\"> \t\t\t<img style=\"position:relative;bottom:0%; right:0%; width:100%; height:99%;\" src=\"images/controlBG.png\">  \t\t\t<img style=\"position:absolute;bottom:8%; right:5%; width:40%; height:10%;\" src=\"images/slider.png\" id=\""+t+"Slider\" >  \t\t\t<div style=\"position:absolute;bottom:8%; right:5%; width:90%; height:65%;\" draggable=\"false\" id=\""+t+"SlideBtn\" \t\t\t\tonmousedown=\"sliderDragStart(event)\" onmousemove=\"sliderDrag(event)\" onmouseup=\"sliderDragStop(event)\" \t\t\t\tontouchstart=\"sliderDragStart(event)\" ontouchmove=\"sliderDrag(event)\" ontouchend=\"sliderDragStop(event)\"></div>  \t\t\t<div style=\"position:absolute;bottom:8%; left:25%; width:5%; height:0%; background-color:#66FF33\" id=\""+t+"LevelGreen\"></div> \t\t\t<div style=\"position:absolute;bottom:57.5%; left:25%; width:5%; height:0%; background-color:#FF6600\" id=\""+t+"LevelOrange\"></div> \t\t\t<div style=\"position:absolute;bottom:66.8%; left:25%; width:5%; height:0%; background-color:#FF0000\" id=\""+t+"LevelRed\"></div> \t\t\t<div style=\"position:absolute;bottom:8%; left:25%; width:5%; height:0%; background-color:#999999\" id=\""+t+"Threshold\"></div> \t\t\t<img style=\"position:absolute;right:14%; top:9.3%;width:72%; padding-bottom:10%;visibility: hidden\" src=\"images/live.png\" id=\""+t+"live\" >  \t\t\t<img style=\"position:absolute;right:30%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/AGCOff.png\" id=\""+t+"AGCOff\" onclick=\"agcButton(event)\">  \t\t\t<img style=\"position:absolute;right:30%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/AGCOn.png\" id=\""+t+"AGCOn\" onclick=\"agcButton(event)\">  \t\t\t<div style=\"position:absolute;top:1%; left:3%; width:90%; height:10%;color:#AAAAAA;font-size: 3vmin\" id=\""+t+"Name\"> \t\t\t\t<marquee behavior=\"slide\" direction=\"left\">"+e.name+"</marquee> \t\t\t</div> \t\t</div>",n=document.getElementById("mixerRack");n.innerHTML+=i,e.displayID=t}function createMicUI(e){let t="ID"+e.channel,i=" <div id=\""+t+"\" style=\"position:relative;width:100px; height:100%; display: inline-block\"> \t\t\t<img style=\"position:relative;bottom:0%; right:0%; width:100%; height:99%;\" src=\"images/controlBG.png\">  \t\t\t<img style=\"position:absolute;bottom:8%; right:5%; width:40%; height:10%;\" src=\"images/slider.png\" id=\""+t+"Slider\" >  \t\t\t<div style=\"position:absolute;bottom:8%; right:5%; width:90%; height:65%;\" draggable=\"false\" id=\""+t+"SlideBtn\" \t\t\t\tonmousedown=\"sliderDragStart(event)\" onmousemove=\"sliderDrag(event)\" onmouseup=\"sliderDragStop(event)\" \t\t\t\tontouchstart=\"sliderDragStart(event)\" ontouchmove=\"sliderDrag(event)\" ontouchend=\"sliderDragStop(event)\"></div>  \t\t\t<div style=\"position:absolute;bottom:8%; left:25%; width:5%; height:0%; background-color:#66FF33\" id=\""+t+"LevelGreen\"></div> \t\t\t<div style=\"position:absolute;bottom:57.5%; left:25%; width:5%; height:0%; background-color:#FF6600\" id=\""+t+"LevelOrange\"></div> \t\t\t<div style=\"position:absolute;bottom:66.8%; left:25%; width:5%; height:0%; background-color:#FF0000\" id=\""+t+"LevelRed\"></div> \t\t\t<div style=\"position:absolute;bottom:8%; left:25%; width:5%; height:0%; background-color:#999999\" id=\""+t+"Threshold\"></div> \t\t\t<img style=\"position:absolute;right:5%; top:10%;width:40%; padding-bottom:10%;\" src=\"images/channelOff.png\" id=\""+t+"Off\" onclick=\"unmuteButton(event)\">  \t\t\t<img style=\"position:absolute;right:5%; top:10%;width:40%; padding-bottom:10%;\" src=\"images/channelOn.png\" id=\""+t+"On\" onclick=\"muteButton(event)\">  \t\t\t<img style=\"position:absolute;left:5%; top:10%;width:40%; padding-bottom:10%;\" src=\"images/StereoOff.png\" id=\""+t+"stereoOff\" onclick=\"stereoOnOff(event)\">  \t\t\t<img style=\"position:absolute;left:5%; top:10%;width:40%; padding-bottom:10%;\" src=\"images/StereoOn.png\" id=\""+t+"stereoOn\" onclick=\"stereoOnOff(event)\">  \t\t\t<img style=\"position:absolute;right:5%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/AGCOff.png\" id=\""+t+"AGCOff\" onclick=\"agcButton(event)\">  \t\t\t<img style=\"position:absolute;right:5%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/AGCOn.png\" id=\""+t+"AGCOn\" onclick=\"agcButton(event)\">  \t\t\t<img style=\"position:absolute;left:5%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/HQOff.png\" id=\""+t+"HQOff\" onclick=\"HQOnOff(event)\">  \t\t\t<img style=\"position:absolute;left:5%; bottom:1%;width:40%; padding-bottom:10%;\" src=\"images/HQOn.png\" id=\""+t+"HQOn\" onclick=\"HQOnOff(event)\">  \t\t\t<div style=\"position:absolute;top:1%; left:3%; width:90%; height:10%;color:#AAAAAA; font-size: 3vmin\" id=\""+t+"Name\"> \t\t\t\t<marquee behavior=\"slide\" direction=\"left\">"+e.name+"</marquee> \t\t\t</div> \t\t</div>",n=document.getElementById("mixerRack");n.innerHTML+=i,e.displayID=t}function removeChannelUI(e){trace2("Removing channel ",e.name);let t=document.getElementById(e.displayID);null!=t&&t.remove(),e.displayID=void 0,e.name="",e.gain=1,e.agc=!0,e.muted=!1,e.peak=0,e.seq=0}function convertIdToObj(id){return id=id.substring(2),parseFloat(id)&&(id=parseFloat(id)),id="number"==typeof id||"0"==id?channels[id]:eval(id),id}function recButton(){trace2("rec");let e=event.target.parentNode.id,t=document.getElementById(e+"talkOn");t.style.visibility="hidden",e=convertIdToObj(e),recording=!0}function muteButton(){let e=event.target.parentNode.id,t=document.getElementById(e+"On");t.style.visibility="hidden",e=convertIdToObj(e),e.muted=!0,micIn.muted&&(document.getElementById("micMuted").style.visibility="visible",document.getElementById("micOpen").style.visibility="hidden")}function unmuteButton(){let e=event.target.parentNode.id,t=document.getElementById(e+"On");t.style.visibility="inherit",e=convertIdToObj(e),e.muted=!1,micIn.muted||(document.getElementById("micMuted").style.visibility="hidden",document.getElementById("micOpen").style.visibility="visible",forcedMute&&(trace2("FORCE UNmute"),micIn.gate=40,forcedMute=!1))}function agcButton(){let e=event.target.parentNode.id,t=convertIdToObj(e),i=document.getElementById(e+"AGCOn");i.style.visibility=t.agc?"hidden":"inherit",t.agc=!t.agc}function stereoOnOff(){let e=event.target.parentNode.id,t=document.getElementById(e+"stereoOn");stereoOn?(t.style.visibility="hidden",stereoOn=!1):(t.style.visibility="inherit",stereoOn=!0)}function HQOnOff(){let e=event.target.parentNode.id,t=document.getElementById(e+"HQOn");HQOn?(t.style.visibility="hidden",HQOn=!1):(t.style.visibility="inherit",HQOn=!0)}var slider={dragging:!1,dragStartY:0,dragStartPct:0};function sliderDragStart(e){slider.dragging=!0,e.target.style.cursor="pointer",slider.dragStartY=e.clientY,isNaN(slider.dragStartY)&&(slider.dragStartY=e.touches[0].clientY);let t=e.target.parentNode.id,i=document.getElementById(t+"Slider");slider.dragStartPct=parseFloat(i.style.bottom)}function sliderDrag(e){if(slider.dragging){let t=e.clientY;isNaN(t)&&(t=e.touches[0].clientY),t=slider.dragStartY-t;let i=100*(.65*(t/e.target.clientHeight));p=slider.dragStartPct+i;let n=e.target.parentNode.id,l=document.getElementById(n+"Slider");8>p&&(p=8),65<p&&(p=65),l.style.bottom=p;let o=document.getElementById(n+"AGCOn");o.style.visibility="hidden";let s;s=42>p?(p-8)/34:(p-39.5)/2.5,n=convertIdToObj(n),n.gain=s,n.agc=!1}}function sliderDragStop(e){e.target.style.cursor="default",slider.dragging=!1}function setStatusLED(e,t){let i=document.getElementById(e);i.className="Red"==t?"redLED":"Orange"==t?"orangeLED":"greenLED"}function maxValue(e){let t,n=0;for(let l=0;l<e.length;l++)t=Math.abs(e[l]),t>n&&(n=t);return n}function avgValue(e){let n=0;for(let t=0;t<e.length;t++)n+=Math.abs(e[t]);return n/e.length}function applyAutoGain(e,t){let n,l,o,s,a,d=t.gain,r=t.targetGain,g=t.ceiling,h=-1*g,u=t.gainRate,m=t.agc;m||(r=d),l=maxValue(e),l*r>g?(o=g/l,trace2("Clipping gain")):o=r,l=0,o>=d?(a=e.length,m&&(o=d+(o-d)/u)):(a=Math.floor(e.length/10),trace2("Gain dropping")),n=d;for(let r=0;r<a;r++)s=r/a,n=d+(o-d)*s,e[r]*=n,e[r]>=g?e[r]=g:e[r]<=h&&(e[r]=h),s=Math.abs(e[r]),s>l&&(l=s);if(a!=e.length){n=o;for(let t=a;t<e.length;t++)e[t]*=n,e[t]>=g?e[t]=g:e[t]<=h&&(e[t]=h),s=Math.abs(e[t]),s>l&&(l=s)}return 1!=g&&(o=d),{finalGain:o,peak:l}}function applyGain(e,t){for(let n=0;n<e.length;n++)e[n]*=t}function fadeUp(e){for(let t=0;t<e.length;t++)e[t]*=t/e.length}function fadeDown(e){for(let t=0;t<e.length;t++)e[t]*=(e.length-t)/e.length}var thresholdBands=[1e-4,2e-4,3e-4,5e-4,7e-4,.001,.002,.003,.005,.007,.01,.02,.03,.05,.07,.1,.2,.3,.5,.7,1,2],levelCategories=Array(thresholdBands.length).fill(0);function levelClassifier(e){for(let t=0;t<thresholdBands.length;t++)if(e<thresholdBands[t]){levelCategories[t]++;break}}function setNoiseThreshold(){let e=0;for(let t=0;14>t;t++)levelCategories[t]>e&&(e=levelCategories[t],noiseThreshold=thresholdBands[t]);if(noiseThreshold*=1.2,trace2("Noise threshold: ",noiseThreshold),0<e)for(let t=0;14>t;t++)levelCategories[t]=100*(levelCategories[t]/e)}var outputPeaks=Array(30).fill(0),micPeaks=Array(30).fill(0),gateDelay=10,openCount=0,gateJustClosed=!1,initialNoiseMeasure=gateDelay,extra=3,oldFactor=30;function processAudio(t){enterState(audioInOutState);let e,i=t.inputBuffer.getChannelData(0),n=t.inputBuffer.getChannelData(1),l=t.outputBuffer.getChannelData(0),o=t.outputBuffer.getChannelData(1),s=t.outputBuffer.getChannelData(2);if(!0==echoTest.running){let e=runEchoTest(i);for(let t in e)l[t]=e[t],o[t]=e[t];return void enterState(idleState)}if(socketConnected){let t=[],l=[];if(e=maxValue(i),micPeaks.unshift(e),micPeaks.pop(),performer)micIn.gate=gateDelay;else{let t=100>openCount?myNoiseFloor:1.5*myNoiseFloor;0<micIn.gate&&e>noiseThreshold&&e>t?(micIn.gate=gateDelay,openCount++):e>micIn.threshold&&e>noiseThreshold&&e>myNoiseFloor&&(micIn.gate=gateDelay,trace2("OPEN ",e.toFixed(2)," > ",micIn.threshold.toFixed(2)))}if(0<initialNoiseMeasure&&(initialNoiseMeasure--,0==initialNoiseMeasure&&(gateJustClosed=!0)),micIn.muted&&(micIn.gate=0),0<micIn.gate?(t=i,l=n,micIn.gate--,0==micIn.gate&&(gateJustClosed=!0,openCount=0)):(t=Array(ChunkSize).fill(0),l=Array(ChunkSize).fill(0)),micBufferL.push(...t),micBufferR.push(...l),micBufferL.length>adjMicPacketSize){let e=micBufferL.splice(0,adjMicPacketSize),t=micBufferR.splice(0,adjMicPacketSize),n={mono8:[],mono16:[]},l=!1,o=0;if(!performer){let t=[],l=[];n=reSample(e,downCache,PacketSize);let s=applyAutoGain(n,micIn);if(s.peak>micIn.peak&&(micIn.peak=s.peak),o=s.peak,micIn.gain=s.finalGain,0==o||micIn.muted||serverMuted)o=0;else{let e,o,s=0;for(let a=0;a<n.length;a+=2)e=(n[a]+n[a+1])/2,o=(n[a]-n[a+1])/2,t[s]=e,l[s]=o,s++}n={mono8:t,mono16:l,mono32:[],stereo8:[],stereo16:[],stereo32:[]};let d=zipson.stringify(n);n=zipson.parse(d)}else if(!micIn.muted){let i=prepPerfAudio(e,t);l=zipson.stringify(i)}else l=zipson.stringify({mono8:[],mono16:[],mono32:[],stereo8:[],stereo16:[],stereo32:[]});let s=performer?PerfSampleRate:SampleRate,i=new Date().getTime(),a={name:myName,audio:n,perfAudio:l,liveClients:1,sequence:packetSequence,timestamp:i,peak:o,channel:myChannel,recording:recording,sampleRate:s,group:myGroup,rtt:rtt1,chatText:chatText};socketIO.emit("u",a),chatText="";let d=JSON.stringify(a).length/1024;bytesSent+=d,performer||packetBuf.push(a),packetsOut++,packetSequence++}}let a=[],d=[];if(!smoothingNeeded||spkrBufferL.length>maxBuffSize/2)if(!(spkrBufferL.length>ChunkSize)){shortages++,pitch<pitchLimit&&pitch++;let e=ChunkSize-spkrBufferL.length;bytesShort+=e,a=spkrBufferL.splice(0,spkrBufferL.length),d=spkrBufferR.splice(0,spkrBufferR.length);let n=400>spkrBufferL.length?spkrBufferL.length:400;for(let e=0;e<n;e++)a[e]*=smooth[Math.round(400*e/n)],d[e]*=smooth[Math.round(400*e/n)];smoothingNeeded=!0;let t=Array(e).fill(0);a.push(...t),d.push(...t)}else if(a=spkrBufferL.splice(0,ChunkSize),d=spkrBufferR.splice(0,ChunkSize),smoothingNeeded){for(let e=0;400>e;e++)a[e]*=1-smooth[e],d[e]*=1-smooth[e];smoothingNeeded=!1}for(let e in(echoRisk&&!performer&&0<micIn.gate&&.5<echoTest.factor||0==a.length)&&(a=Array(ChunkSize).fill(0),d=Array(ChunkSize).fill(0)),l)l[e]=a[e],o[e]=d[e];let r=[];if(!smoothingNeededV||venueBuffer.length>maxBuffSize/2)if(!(venueBuffer.length>ChunkSize)){shortages++,pitch<pitchLimit&&pitch++,r=venueBuffer.splice(0,venueBuffer.length);let e=400>venueBuffer.length?venueBuffer.length:400;for(let t=0;t<e;t++)r[t]*=smooth[Math.round(400*t/e)];smoothingNeededV=!0;let t=Array(ChunkSize-venueBuffer.length).fill(0);r.push(...t)}else if(r=venueBuffer.splice(0,ChunkSize),smoothingNeeded){for(let e=0;400>e;e++)a[e]*=1-smooth[e],d[e]*=1-smooth[e];smoothingNeededV=!1}for(let e in(echoRisk&&!performer&&0<micIn.gate&&.5<echoTest.factor||0==r.length)&&(r=Array(ChunkSize).fill(0)),s)s[e]=r[e];let g=new Date().getTime();delta=g-previous,delta>deltaMax&&(deltaMax=delta),delta<deltaMin&&(deltaMin=delta),previous=g;let h=maxValue(a),u=maxValue(d),m=maxValue(r);if(h<u&&(h=u),h<m&&(h=m),outputPeaks.unshift(h),outputPeaks.pop(),gateJustClosed&&(myNoiseFloor=1.2*maxValue(micPeaks.slice(0,9)),trace2("noiseFloor ",myNoiseFloor),gateJustClosed=!1),!echoRisk)return micIn.threshold=0,void enterState(idleState);let y=Math.round(echoTest.sampleDelay),v=0,f=0;for(let e=y;e<outputPeaks.length;e++)v+=outputPeaks[e];for(let e=0;e<micPeaks.length-y;e++)f+=micPeaks[e];let b=micPeaks.length-y;v/=b,f/=b;let k=4*myNoiseFloor;if(1<k&&(k=1),v>k&&f<myNoiseFloor?goodCount++:goodCount=0,5<goodCount)return micIn.threshold=0,0<echoTest.factor&&(oldFactor=echoTest.factor),echoTest.factor=0,void enterState(idleState);0==echoTest.factor&&f>v&&f>myNoiseFloor&&(micIn.gate=0,echoTest.factor=oldFactor);let I=outputPeaks.length,B=micPeaks.length,E=[];for(let e,i=0;15>i;i++){e=0;for(let t=0;t<B;t++)e+=outputPeaks[(i+t)%I]*micPeaks[t];E.push(e)}let D=100;max=0,min2=100;let O=0,w=0,S=0;for(let e=0;e<E.length;e++)w<=O&&E[e]<D&&(D=E[e],O=e),E[e]>max&&(max=E[e],w=e),w<e&&O<w&&E[e]<min2&&(min2=E[e],S=e);if(O<w-3&&w<S-3&&.2<(max-D)/max&&.2<(max-min2)/max){let e=0,t=0,n=0,l=0,o=0,s=0,a=0;for(let d=0;d<I-w;d++){let i=micPeaks[d],r=outputPeaks[d+w];0<r&&(e+=i/r,t++),n+=i,l+=r,o+=i*r,s+=i*i,a+=r*r}let d=(I-w)*o-n*l,r=(I-w)*s-n*n,g=(I-w)*a-l*l,h=Math.sqrt(r*g),u=d/h;e/=t,.9<u&&isFinite(e)&&80>e&&(echoTest.factor=e>echoTest.factor?(3*echoTest.factor+e*extra)/4:(39*echoTest.factor+e*extra)/40,echoTest.sampleDelay=(39*echoTest.sampleDelay+w)/40,trace2("R ",e.toFixed(1)," f ",echoTest.factor.toFixed(1)," d ",echoTest.sampleDelay.toFixed(1)," c ",u.toFixed(1)),0<micIn.gate&&trace2("Breach detected. "))}y=Math.round(echoTest.sampleDelay);let G=y-3;0>G&&(G=0);let C=y+3;C>outputPeaks.length&&(C=outputPeaks.length);let F;F=maxValue(outputPeaks.slice(G,C))*echoTest.factor*mixOut.gain,1.5<F&&(F=1.5),micIn.threshold=F,0==blocked&&0<F&&outputPeaks[0]>outputPeaks[1]&&outputPeaks[0]>noiseThreshold&&(blocked=40,micIn.threshold=1.2),0<blocked&&(blocked--,0==blocked&&(blocked=-40)),0>blocked&&(h<myNoiseFloor?blocked++:blocked=-40),enterState(idleState)}function prepPerfAudio(e,t){let n=!1;if(stereoOn)for(let l=0;l<e.length;l++)e[l]!=t[l]&&(n=!0);e=reSample(e,downCachePerfL,PerfPacketSize),n&&(t=reSample(t,downCachePerfR,PerfPacketSize));let l;if(n){let i=maxValue(e),n=maxValue(t);i>n?(l=applyAutoGain(e,micIn),applyGain(t,l.finalGain)):(l=applyAutoGain(t,micIn),applyGain(e,l.finalGain))}else l=applyAutoGain(e,micIn);l.peak>micIn.peak&&(micIn.peak=l.peak),micIn.gain=l.finalGain;let o=[],s=[];if(n)for(let n=0;n<e.length;n++)o[n]=e[n]+t[n],s[n]=e[n]-t[n];else o=e;let a=[],d=[],r=[],g=[],h=[],u=[],m=0,y=0;for(let n=0;n<o.length;n+=4){let e,t,i,l,s,g;e=(o[n]+o[n+1])/2,i=(o[n]-o[n+1])/2,t=(o[n+2]+o[n+3])/2,l=(o[n+2]-o[n+3])/2,s=(e+t)/2,g=(e-t)/2,a[m]=s,d[m]=g,m++,r[y]=i,y++,r[y]=l,y++}if(m=0,y=0,n)for(let e=0;e<s.length;e+=4){let t,i,n,l,o,a;t=(s[e]+s[e+1])/2,n=(s[e]-s[e+1])/2,i=(s[e+2]+s[e+3])/2,l=(s[e+2]-s[e+3])/2,o=(t+i)/2,a=(t-i)/2,g[m]=o,h[m]=a,m++,u[y]=n,y++,u[y]=l,y++}HQOn||(r=[],u=[]);let i={mono8:a,mono16:d,mono32:r,stereo8:g,stereo16:h,stereo32:u};return i}var micFilter1,micFilter2,context,reverb,reverbFile="";function handleAudio(e){let t=window.AudioContext||window.webkitAudioContext||!1;t?context=new t:alert("Sorry, the Web Audio API is not supported by your browser. Consider upgrading or using Google Chrome or Mozilla Firefox"),soundcardSampleRate=context.sampleRate,micAudioPacketSize=Math.round(PacketSize*soundcardSampleRate/SampleRate),adjMicPacketSize=micAudioPacketSize,micAccessAllowed=!0,createOutputUI(mixOut),createMicUI(micIn),createChannelUI(venue),echoRisk=!(-1!=navigator.userAgent.toLowerCase().indexOf("firefox")),tracef("Browser echoRisk is ",echoRisk);let i,n=context.createMediaStreamSource(e);i=context.createScriptProcessor?context.createScriptProcessor(ChunkSize,2,3):context.createJavaScriptNode(ChunkSize,2,3),i.onaudioprocess=processAudio,micFilter1=context.createBiquadFilter(),micFilter1.type="lowpass",micFilter1.frequency.value=HighFilterFreq,micFilter1.Q.value=1,micFilter2=context.createBiquadFilter(),micFilter2.type="highpass",micFilter2.frequency.value=LowFilterFreq,micFilter2.Q.value=1,reverb=context.createConvolver(),reverb.buffer=impulseResponse(1,16),reverb.normalize=!0;let l=context.createChannelSplitter(),o=context.createChannelMerger();n.connect(micFilter1),micFilter1.connect(micFilter2),micFilter2.connect(i),i.connect(l),l.connect(o,0,0),l.connect(o,1,1),o.connect(context.destination),l.connect(context.destination,2),reverb.connect(context.destination),startEchoTest()}function loadVenueReverb(e){if(e==reverbFile)return;if(""==e)return void(reverb.buffer=impulseResponse(1,16));let t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onreadystatechange=function(){4==this.readyState&&200==this.status&&context.decodeAudioData(t.response,function(t){reverb.buffer=t,reverbFile=e,console.log(e," loaded into reverb")})},t.send(),console.log("Requested to load ",e)}function impulseResponse(e,t){let n=soundcardSampleRate*e,l=context.createBuffer(2,n,soundcardSampleRate),o=l.getChannelData(0),s=l.getChannelData(1);t||(t=2);let a,d,r,g,h,u,m;a=d=r=g=h=u=m=0;for(let l=0;l<n;l++){let e,i=2*Math.random()-1;a=.99886*a+.0555179*i,d=.99332*d+.0750759*i,r=.969*r+.153852*i,g=.8665*g+.3104856*i,h=.55*h+.5329522*i,u=-.7616*u-.016898*i,e=a+d+r+g+h+u+m+.5362*i,e*=.11,m=.115926*i;let y=(2*Math.random()-1)*Math.pow(1-l/n,t);o[l]=y*Math.random(),s[l]=y*Math.random()}return l}document.addEventListener("DOMContentLoaded",function(){initAudio()});function initAudio(){let e={mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},optional:[]};navigator.getUM=navigator.getUserMedia||navigator.webKitGetUserMedia||navigator.moxGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.mediaDevices.getUserMedia?(trace("Using GUM with promise"),navigator.mediaDevices.getUserMedia({audio:e}).then(function(e){handleAudio(e)}).catch(function(t){trace(t.name+": "+t.message)})):(trace("Using OLD GUM"),navigator.getUM({audio:e},function(e){handleAudio(e)},function(){trace("Audio HW is not accessible.")}))}var downCache=[0,0],vCache=[0,0],gLCache=[0,0],gRCache=[0,0],downCachePerfL=[0,0],downCachePerfR=[0,0],upCachePerfM=[0,0],upCachePerfS=[0,0];function reSample(e,t,n){let l=e.length/n,o=Array(n).fill(0);for(let s=0;s<n-1;s++){let i=l-1+s*l,n=Math.round(i);for(let l,a=-1;2>a;a++)l=e[n+a],isNaN(l)&&(l=t[1+a]),isNaN(l)&&(l=e[n]),o[s]+=l*magicKernel(i-n-a)}return t[0]=e[e.length-2],t[1]=o[n-1]=e[e.length-1],o}function magicKernel(e){if(-.5>e)return .5*(e+1.5)*(e+1.5);return .5<e?.5*(e-1.5)*(e-1.5):.75-e*e}var echoRisk=!0,echoTest={running:!1,steps:[16,8,128,64,32,1,.5,.2,.1,.05,.02,0],currentStep:0,analysisStep:0,tones:[],samplesNeeded:0,results:[],delays:[],delay:129,factor:4,sampleDelay:6};echoTest.steps.forEach(e=>{if(1<e){let t=[];for(let i=0;i<ChunkSize;i++)t.push(Math.sin(Math.PI*i/(ChunkSize/(2*e))));echoTest.tones[e]=t}else if(0<e){let t=[];for(let i=0;i<ChunkSize;i++)t.push(e*Math.sin(Math.PI*i/(ChunkSize/64)));echoTest.tones[e]=t}});function startEchoTest(){!1==echoTest.running&&(trace2("Starting echo test"),echoTest.running=!0,echoTest.currentStep=0,echoTest.analysisStep=0,echoTest.results=[],echoTest.delays=[])}function runEchoTest(e){let t,i=echoTest.steps[echoTest.currentStep];if(0<i)0==echoTest.samplesNeeded?(trace2("Running test ",i),t=echoTest.tones[i],echoTest.results[i]=[],echoTest.samplesNeeded=10):(echoTest.results[i].push(...e),t=Array(ChunkSize).fill(0),echoTest.samplesNeeded--,0==echoTest.samplesNeeded&&echoTest.currentStep++);else{let e=echoTest.steps[echoTest.analysisStep];if(0<e){let t=echoTest.results[e];trace2("Analyzing ","test "+e);let i=echoTest.tones[e],n=i.length,l=[];for(let e,o=0;o<t.length-n;o++){e=0;for(let l=0;l<n;l++)e+=t[o+l]*i[l];l.push(e)}let o=0,s=0;for(let e=0;e<l.length;e++)l[e]>o&&(o=l[e],s=e);let a=10*Math.round(100*s/soundcardSampleRate);trace2("Pulse delay is ",a,"mS"),echoTest.delays.push(a.toFixed(0))}else{trace2("Reviewing results");let e=[];echoTest.delays.forEach(t=>{null==e[t]?e[t]=1:e[t]++});let t=0,i=!1;for(let n in e)e[n]>t&&(t=e[n]),0<n&&5<e[n]&&(trace2("Delay is ",n),i=!0,echoTest.delay=n,echoTest.sampleDelay=Math.ceil(echoTest.delay*soundcardSampleRate/1e3/1024),trace2("Sample delay is ",echoTest.sampleDelay));if(i){echoRisk=!0;let e=Math.round(echoTest.delay*soundcardSampleRate/1e3),n=[];for(let l,t=0;t<echoTest.steps.length-1;t++)if(l=echoTest.steps[t],1>=l){let i=echoTest.results[l].slice(e,e+1024),o=avgValue(i),s=o/(.637*l);trace2("Test ",echoTest.steps[t]," Factor: ",s),n.push(s)}echoTest.factor=3*avgValue(n),echoTest.factor=30,echoRisk=!0,trace2("Forced factor is ",echoTest.factor)}else trace2("No clear result. Echo risk should be low."),echoTest.factor=0;echoTest.running=!1}echoTest.analysisStep++}return t}var currentMonitor=0,monitors=["none","monitor","monitor2"];document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("monitorBtn");e.onclick=function(){if("none"!=monitors[currentMonitor]){let e=document.getElementById(monitors[currentMonitor]);e.style.visibility="hidden",e.parentNode.style.visibility="hidden"}if(currentMonitor++,currentMonitor==monitors.length&&(currentMonitor=0),"none"!=monitors[currentMonitor]){let e=document.getElementById(monitors[currentMonitor]);e.style.visibility="visible",e.parentNode.style.visibility="visible"}};let t=document.getElementById("settingsBtn");t.onclick=function(){trace2("Settings Button Pressed"),toggleSettings()};let i=document.getElementById("testBtn");i.onclick=function(){trace2("Echo Test Button Pressed"),startEchoTest()};let n=document.getElementById("actionBtn");n.onclick=function(){trace("Pause traces pressed"),pauseTracing=!0!=pauseTracing}});var delta,previous,pauseTracing=!0,packetsIn=0,packetsOut=0,bytesSent=0,bytesRcvd=0,overflows=0,shortages=0,bytesOver=0,bytesShort=0,packetSequence=0,tracecount=0,sendShortages=0,spkrBuffPeak=0,spkrBuffTrough=maxBuffSize,deltaMax=0,deltaMin=1e4,pitch=0;const pitchLimit=12;function everySecond(){enterState(UIState);let e=.1<(rtt1-rtt5)/rtt5&&400<rtt5?"UNSTABLE":"stable";pauseTracing||(trace(packetsOut,"/",packetsIn," over:",overflows,"(",bytesOver,") short:",shortages,"(",bytesShort,") RTT=",rtt.toFixed(1)," ",rtt1.toFixed(1)," ",rtt5.toFixed(1)," ",e," a:",audience," sent:",bytesSent.toFixed(1)," rcvd:",bytesRcvd.toFixed(1)),trace("Venue buffer:",venueBuffer.length," speaker buff:",spkrBufferL.length,"(",spkrBuffTrough," - ",spkrBuffPeak,") Delta max/min:",deltaMax,"/",deltaMin," pitch:",pitch)),!0==performer?(document.getElementById("onair").style.visibility="visible",micFilter1.frequency.value=PerfSampleRate/2.2,micFilter2.frequency.value=30):(document.getElementById("onair").style.visibility="hidden",micFilter1.frequency.value=HighFilterFreq,micFilter2.frequency.value=LowFilterFreq,document.getElementById("live").style.visibility=liveShow?"visible":"hidden"),document.getElementById("ID"+mixOut.channel+"live").style.visibility=liveShow?"inherit":"hidden";let t="Green";(1<overflows||1<shortages||"stable"!=e)&&(t="Orange"),!1==socketConnected&&(t="Red"),setStatusLED("GeneralStatus",t);let i=1.2*(SampleRate/PacketSize),n=.8*(SampleRate/PacketSize),l="Green";(packetsOut<n||packetsOut>i)&&(l="Orange"),packetsOut<n/3&&(l="Red"),setStatusLED("UpStatus",l);let o="Green";(packetsIn<n||packetsIn>i)&&(o="Orange"),packetsIn<n/3&&(o="Red"),setStatusLED("DownStatus",o),packetsIn=0,packetsOut=0,bytesSent=0,bytesRcvd=0,overflows=0,shortages=0,bytesOver=0,bytesShort=0,rtt=0,tracecount=15,spkrBuffPeak=0,spkrBuffTrough=maxBuffSize,deltaMax=0,deltaMin=1e4,pitch=pitch>pitchLimit?pitchLimit:pitch,pitch=pitch<-12?-12:pitch,adjMicPacketSize!=micAudioPacketSize+pitch&&trace("PITCH CHANGE"),updateUIMute(),enterState(idleState)}setInterval(everySecond,1e3);var traceDiv=null,traceDiv2=null,traceArray=[],traceArray2=[],maxTraces=100;document.addEventListener("DOMContentLoaded",function(){traceDiv=document.getElementById("Trace"),traceDiv2=document.getElementById("Trace2")});function trace(){if(!1==pauseTracing){let e="";for(let t=0;t<arguments.length;t++)e+=arguments[t];console.log(e),traceArray.push(e+"<br>"),traceArray.length>maxTraces&&traceArray.shift(0,1),null!=traceDiv&&(traceDiv.innerHTML=traceArray.join(""),traceDiv.scrollTop=traceDiv.scrollHeight)}}function tracef(){let e="";for(let t=0;t<arguments.length;t++)e+=arguments[t];console.log(e),traceArray.push(e+"<br>"),traceArray.length>maxTraces&&traceArray.shift(0,1),null!=traceDiv&&(traceDiv.innerHTML=traceArray.join(""),traceDiv.scrollTop=traceDiv.scrollHeight)}function trace2(){if(!1==pauseTracing){let e="";for(let t=0;t<arguments.length;t++)e+=arguments[t];console.log(e),traceArray2.push(e+"<br>"),traceArray2.length>maxTraces&&traceArray2.shift(0,1),null!=traceDiv2&&(traceDiv2.innerHTML=traceArray2.join(""),traceDiv2.scrollTop=traceDiv2.scrollHeight)}}function stateTimer(){this.name="",this.total=0,this.start=0}var idleState=new stateTimer;idleState.name="Idle";var dataInState=new stateTimer;dataInState.name="Data In";var audioInOutState=new stateTimer;audioInOutState.name="Audio In/Out";var UIState=new stateTimer;UIState.name="UI updating";var currentState=idleState;currentState.start=new Date().getTime();function enterState(e){let t=new Date().getTime();currentState.total+=t-currentState.start,e.start=t,currentState=e}enterState(idleState);